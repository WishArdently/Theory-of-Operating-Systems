## 文件管理

### 一、用户视角

#### 1、概念

**文件**：一段程序或者数据的集合、操作系统对物理存储设备的一种抽象、记录在外存上的相关信息的命名组合、*逻辑外存的最小分配单位*、存储信息。

**属性**：名称、标识符（唯一标记）、类型、位置、尺寸、保护、时间日期等。

**操作**：创建、读/写、定位、删除、截断（保留属性）、打开、关闭、追加写、重命名、读取性质、修改性质。

**打开文件**：打开文件表、文件指针（读写位置）、打开计数、磁盘位置、访问权限

**文件锁**：共享锁——多进程可同时访问

​				独占锁——只允许一个进程访问

**文件类型**：exe、cpp、pl、sql、h、mp4、etc.

#### 2、文件结构

（1）**内部结构**

磁盘管理通常以块为单位。

文件即**逻辑块序列**。

文件的逻辑块与物理块的对应关系决定了文件定位的方式

UNIX下：使用字节流编块。逻辑块大小为1KB，多个逻辑块会存入一个物理磁盘块。

磁盘以块为单位会导致文件最后一块存在浪费。

（2）**访问方法**

**顺序访问**：按顺序处理

提供操作：read next、write next、reset（跳到文件头）skip forward（快进）、skip backward（快退）

**直接访问**：允许随机访问物理块，并进行读写操作。

提供操作：read n、write n、postion to n、read next、write next、rewrite n

定长记录：与数组类似的访问方式。

变长记录：采用索引文件组织。

#### 3、目录与磁盘结构

**文件组织**

（1）分区：存储设备可以划分为多个分区（C，D，E）,每个分区可以有单独的文件系统

卷：包含文件系统的分区。

（2）目录：记录卷上所有文件的信息。

多个分区可共享一个磁盘，一个分区可以跨多个磁盘。

**目录**

是一个包含所有文件信息的节点的集合。本身也存存储在磁盘上。

（1）单级目录

所有文件都在同一目录下。

不允许重名、管理混乱。

（2）两级目录

为每个用户创建一个单独目录。

主文件目录（MFD）+用户文件目录（UFD）

不同用户的文件名可相同、用户间文件互访可通过完整路径名。

（3）树形目录

目录是一个特殊文件，每个进程有一个当前目录，引用文件时将搜素目录；如果文件不在当前目录，用户需指定路径。

创建文件默认在当前文件夹下完成；

绝对路径：从根路径开始

相对路径：从当前路径开始

（4）无环图目录

文件可能拥有多个绝对路径名——不同的文件名指向同一个文件。

缺点：影响磁盘利用率的准确计算、备份、删除。

**硬链接**：指向同一个文件在硬盘中的区块。——指向目标inode

**软链接**：保存了其代表文件的绝对路径。——可以跨文件卷、可链接到同一个目录（快捷方式）

​																	 ——指向另外一个inode，此inode的链接区有一个指向目标目录的指针。

（5）通用图目录（允许环存在）

降低搜索性能、删除操作复杂。

#### 4、文件保护

访问模式：read、write、execute。

对不同用户进行权限限制。

### 二、系统视角

#### 1、文件系统结构

文件的整体结构（目录+文件）都是存放在磁盘里。

原因：可以原地重写。可以直接访问磁盘上任意一块信息。——方便顺序和随机访问

自底向上可分为：

（1）*最底层*：对I/O设备的控制——设备驱动程序+中断处理程序。

（2）*基本文件系统*：完成以物理块为单位的数据读写。——访问磁盘地址（驱动器、柱面、磁道、扇区）

（3）*文件组织模块*：知晓文件的逻辑块和物理块，根据文件类型分配空间及位置，地址变换。

（4）*逻辑文件系统*：管理文件系统元数据（文件系统所有结构数据，不包括文件内容）——通过FCB维护文件结构

（5）*应用程序*：进行文件操作。

#### 2、磁盘空间分配

（1）**连续分配**

将文件信息存放于若干连续物理块中。

特点：顺序存取速度快，所需的磁盘寻道次数和寻道时间最少。

优点：简单、支持随机访问。

缺点：要求有连续的存储空间，不能动态增长，不利于插入和删除，外碎片。

（2）**链接分配**

每个磁盘快中留出一个指针，用来进行块间链接。

优点：实现简单，空间管理浪费较少

缺点：不支持随机访问

（3）**索引分配**

系统为每个文件建立一个索引表——逻辑块号$\rightarrow$物理块号

优点：既可以满足动态增长需求，又可以实现随机存取。

缺点：索引表增加了存储空间的开销。操作需要访问存储器两次以上，降低存取速度。

#### 3、inode表（Index Node）

存储设备是分成若干个大小相等的物理块，以块为单位来交换信息。

**inode**：记录文件元数据的一种结构，文件与inode一一对应，每个inode有自己的单独编号，记录文件的磁盘块

多个文件名可能指向同一个inode，目录文件中的数据包括文件名和inode

可通过inode访问文件的所有数据。

每个数据块号按顺序记录在inode中

缺点：inode表占用大量存储空间，资源浪费

#### 4、UNIX文件系统

直接指针：指向数据块

一级间接指针：指向一级索引块

二级间接指针：指向二级索引块

三级间接指针：指向三级索引块

文件大小求解例题：
<img src="C:\Users\16958\AppData\Roaming\Typora\typora-user-images\image-20231223211249622.png" alt="image-20231223211249622" style="zoom:60%;" />

### 三、文件存储空间管理

#### 1、空闲块的管理

**（1）空闲空间表（空闲文件目录）**

把一个连续的未分配区域，看成一个文件，称为空白文件。

系统为所有空白文件建立一个目录，即*空白文件目录*，每一个表项对应一个空闲区。

分配：查找$\rightarrow$分配$\rightarrow$更新

回收：插入、合并

适用于少量空白文件的文件系统。（过大会导致目录过大）

适用于连续分配。

**（2）空闲块链**

把文件存储设备上的所有空闲块链接在一起

分配：从链头摘取空闲块，调整链首指针。

回收：把释放的空闲块逐个插入链尾上。

常用链接方法：按空闲区大小顺序链接；按释放先后顺序链接。——系统开销增大

**成组链法**：在第一个空闲块中存储n个空闲块地址，前n-1个确实为空，最后一个地址指向另外n个空闲块地址。

<img src="C:\Users\16958\AppData\Roaming\Typora\typora-user-images\image-20231223214025864.png" alt="image-20231223214025864" style="zoom:60%;" />

**（3）位示图**

通过位图进行文件存储空间的分配与回收（状态压缩）

位图尺寸固定，保存在主存中。

<img src="C:\Users\16958\AppData\Roaming\Typora\typora-user-images\image-20231223214528873.png" alt="image-20231223214528873" style="zoom:80%;" />

块号 = 字号 * 字长 + 位号（本张位示图中字长 = 16）

分配：找到合适的0的序列

回收：将相关块位设置为0

当位图过大时，可将图放入副存中，一次取用一段。



